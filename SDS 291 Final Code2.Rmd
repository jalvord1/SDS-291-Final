---
title: "SDS 291 Final"
author: "Julianna Alvord, Emily Halstead, Sabrina Sayasith"
date: "12/7/2017"
output: pdf_document
---

#This is going to be the working code for our document
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(mosaic)
library(tidyverse)
library(stringr)

MentalHealth <- read_csv("survey.csv")
glimpse(MentalHealth)
```

##Data Cleaning
# Modifying Age
limit age between 5-117
if outside of range, set as NaN (not a number)

```{r}
MentalHealth$Age[MentalHealth$Age < 5 | MentalHealth$Age > 117] <- NaN
```

#State for country outside of the United States
```{r}
#if the country is not the US, set state as Outside
MentalHealth$state[MentalHealth$Country != "United States"] <- "Outside US"
```

#Setting United States Regions and Divisions 
```{r}
#if the state is set as "Outside US", set region as "Outside US"
#if state doesnt match any of the valid states and is not "Outside US", Set as "Invalid State"
Northeast <- c("CT", "ME", "MA", "NH", "RI", "VT", "NJ", "NY", "PA")
NewEngland <- c("CT", "ME", "MA", "NH", "RI", "VT")
MidAtlantic <- c("NJ", "NY", "PA")
Midwest <- c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD")
EastNorthCentral <- c("IL", "IN", "MI", "OH", "WI")
WestNorthCentral <- c("IA", "KS", "MN", "MO", "NE", "ND", "SD")
South <- c("DE", "FL", "GA", "MD", "NC", "SC", "VA", "DC", "WV", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX")
SouthAtlantic <- c("DE", "FL", "GA", "MD", "NC", "SC", "VA", "DC", "WV")
EastSouthCentral <- c("AL", "KY", "MS", "TN")
WestSouthCentral <- c("AR", "LA", "OK", "TX")
West <- c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA")
Mountain <- c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY")
Pacific <- c("AK", "CA", "HI", "OR", "WA")
MentalHealth <- MentalHealth %>% mutate(Region = ifelse(state %in% Northeast, "Northeast", ifelse(state %in% Midwest, "Midwest", ifelse(state %in% South, "South", ifelse(state %in% West, "West", ifelse(state == "Outside US", "Outside US", "Invalid State"))))))

# Set the Region
MentalHealth <- MentalHealth %>% mutate(Division = ifelse(state %in% NewEngland, "New England", ifelse(state %in% MidAtlantic, "Mid Atlantic", ifelse(state %in% EastNorthCentral, "East North Central", ifelse(state %in% WestNorthCentral, "West North Central", ifelse(state %in% SouthAtlantic, "South Atlantic", ifelse(state %in% EastSouthCentral, "East South Central", ifelse(state %in% WestSouthCentral, "West South Central", ifelse(state %in% Mountain, "Mountain", ifelse(state %in% Pacific, "Pacific", ifelse(state == "Outside US", "Outside US", "Invalid State")))))))))))
```

#Gender
```{r}
MentalHealth$Gender <- str_to_upper(MentalHealth$Gender)

MentalHealth$Gender <- str_trim(MentalHealth$Gender)

MentalHealth <- MentalHealth %>%
  mutate(Gender_Grouped = 
           ifelse(Gender %in% c("CIS FEMALE", "FEMAIL", "FEMALE", "FEMALE (TRANS)", "TRANS WOMAN", "WOMAN", "CIS-FEMALE/FEMME", "F", "FEMAKE", "FEMALE (CIS)", "TRANS-FEMALE"), "Female",
            ifelse(Gender %in% c("CIS MAN", "M", "MAILE", "MAL", "MALE (CIS)", "MALE-ISH", "MAN", "CIS MALE", "GUY (-ISH) ^_^", "MAIL", "MAKE", "MALE", "MALE LEANING ANDROGYNOUS", "MALR", "MSLE", "OSTENSIBLY MALE, UNSURE WHAT THAT REALLY MEANS", "SOMETHING KINDA MALE?"), "Male", 
              ifelse(is.na(Gender), "NA",
                ifelse(Gender %in% c("GENDERQUEER", "NON-BINARY", "QUEER/SHE/THEY", "ANDROGYNE", "FLUID", "QUEER"),"Gender Non-Conforming", "Other")))))

tally(MentalHealth$Gender_Grouped)

MentalHealth <- MentalHealth %>%
  mutate(Male = 
              ifelse(Gender_Grouped %in% c("Female", "Gender Non-Conforming"), "Not_Male",
                  ifelse(Gender_Grouped == "Male", "Male",
                  ifelse(Gender_Grouped == "NA", "NA", "Other"))))

MentalHealth <- MentalHealth %>%
  filter(Male %in% c("Not_Male", "Male"))
```

#Treatment to binary 0 or 1
Currently, treatment is coded as 'Yes' or 'No'. We want Yes = 1 and No = 0, so we can use it in glm function.
```{r}
MentalHealth <- MentalHealth %>% mutate(treatmentBinary = ifelse(treatment=="Yes", 1, 0))
```

#Starting Results
```{r}
logm1 <- glm(treatmentBinary ~ Male + Age + Division + leave + tech_company, data=MentalHealth, family=binomial)
summary(logm1)
```


# Exploratory Data Analysis
### Treatment, Age, and Gender Identity
```{r}
library(ggplot2)
```

```{r}
treatmentAgeGenderBox <- ggplot(data = MentalHealth, aes(x= treatment, y = Age, fill = Gender_Grouped)) + geom_boxplot()
treatmentAgeGenderBox
```

# 

```{r}
treatmentAgeBox <- ggplot(data = MentalHealth, aes(x= treatment, y = Age)) + geom_boxplot()
treatmentAgeBox
```

There doesn't seem to be a significant difference in the ages of those who get treatment and those who don't.

### Is there a difference between regions? region, treatment, gender within region?
```{r}
divAgeBox <- ggplot(data = MentalHealth, aes(x = Region, y = Age, colour = treatment)) + geom_boxplot()
divAgeBox
```

```{r}
boxNo_Employees <- ggplot(data = MentalHealth, aes(x = no_employees, y = Age, fill = treatment)) + geom_boxplot()
boxNo_Employees
```


```{r}
boxLeave <- ggplot(data = MentalHealth, aes(x = leave, y = Age, fill = treatment)) + geom_boxplot()
boxLeave
```


## Chi-Square. Do the distributions of categorical variables differ from each other?

```{r}
library(reshape2)
#Create contingency tables for chi square
treatDivision <- dcast(MentalHealth, treatment~Division, fill = 0) #treatment vs Division
treatRegion <- dcast(MentalHealth, treatment~Region, fill = 0) #treatment vs Region
treatNo_Employees <- dcast(MentalHealth, treatment~no_employees, fill = 0) #treatment vs No_Employees
treatLeave <- dcast(MentalHealth, treatment~leave, fill = 0) #treatment vs Leave
```
 
### Chi-Square:  treatment vs leave

```{r}
#chi square test between treatment and Leave
#For treatment vs no treatment, is there a significant difference in the distributions of the 4 different "leave" groups (Don't Know, Somewhat difficult, Somewhat easy, Very difficult),
#Is "leave"" related to treatment? Is the distribution of leave between treatment and no treatment what we would expect from chance?
#H0:The variables are independent. 
#HA: The variables are not independent. 
chisq.test(treatLeave[c(2:5)])
#p-value = 1.941e-06, smaller than our .05 confidence level
#We reject the null hypothesis that the variables are independent. There is a relationship between treatment and leave.

#melt dataframe for plotting
treatLeaveMelt <- melt(treatLeave, id.vars = 'treatment')
#visualization of the differences
ggplot(treatLeaveMelt, aes(treatment, value)) + geom_bar(aes(fill=variable), position = "dodge", stat="identity")
#all in all, the distributions for yes treatment vs no treatment look pretty similar

#odds the person has sought treatment for a mental illness depending on how easy it is for them to leave for a mental health condition
Odds_DontKnowLeave <- 232/309
Odds_SomewhatDifficultLeave <- 82/44
Odds_SomewhatEasyLeave <- 130/135
Odds_VeryDifficultLeave <- 65/31 
Odds_VeryEasyLeave <- 101/103

#Odds Ratio Comparisons
OR_VDifficult_VEasy <- Odds_VeryDifficultLeave/Odds_VeryEasyLeave
OR_VDifficult_VEasy
#OR= 2.138294. The odds of seeking treatment were 2.138 times higher with those who said that it is very diffiicult for them to leave for a mental health condition that with those who said it would be very easy to leave
```

